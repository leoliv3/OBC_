<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One Base Control - Gest√£o Local</title>
    <!-- Carregamento do Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configura√ß√£o do Tailwind para usar a fonte Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root { font-family: 'Inter', sans-serif; }
        
        .ship-in-transit {
            animation: move-ship 4s infinite linear;
        }

        @keyframes move-ship {
            0% { transform: translateX(0) rotate(0deg); }
            50% { transform: translateX(10px) rotate(3deg); }
            100% { transform: translateX(0) rotate(0deg); }
        }
        
        #inventory-control th.sticky {
            position: sticky;
            left: 0;
            z-index: 10;
        }
        #inventory-control th.sticky.left-16 {
            left: 64px;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen p-4 md:p-8 text-gray-100">

    <div class="max-w-7xl mx-auto">
        <div class="text-sm text-gray-500 mb-4 text-left flex justify-between items-center">
            <div>
                <span class="bg-blue-900/40 text-blue-400 px-2 py-1 rounded font-bold mr-2">MODO GEST√ÉO LOCAL</span>
                √öltima Atualiza√ß√£o: <span id="last-update-time" class="text-yellow-400">Pendente de Importa√ß√£o</span>
            </div>
            <div id="status-indicator" class="text-green-400 font-bold">Pronto para a Apresenta√ß√£o</div>
        </div>
    </div>

    <header class="text-center mb-10">
        <h1 class="text-4xl font-extrabold text-white mb-2">One Base Control (Painel de Consolida√ß√£o)</h1>
        <p class="text-xl text-gray-400">Gest√£o Integrada: Da Consolida√ß√£o de Pedidos ao Monitoramento do Fluxo Log√≠stico.</p>
        
        <div id="controls" class="mt-8 flex flex-wrap justify-center gap-4 space-y-2 md:space-y-0">
            <button onclick="window.handleImportClick('master')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200">
                üì• Importar POs / Remessas
            </button>
            <button onclick="window.handleImportClick('sop')" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200">
                üìä Importar S&OP / Estoque
            </button>
            
            <div class="relative inline-block text-left">
                <button id="dropdownBtn" type="button" onclick="window.toggleDropdown()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 flex items-center">
                    üìÑ Baixar Modelos CSV
                    <svg class="ml-2 w-4 h-4" xmlns="http://www.w3.org/2000/swap" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div id="dropdownMenu" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-gray-700 ring-1 ring-black ring-opacity-5 z-20 hidden">
                    <div class="py-1">
                        <a href="#" onclick="window.handleDownloadTemplateCSV(); return false;" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">Modelo Mestre (Log√≠stica)</a>
                        <a href="#" onclick="window.handleDownloadSOPTemplate(); return false;" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">Modelo S&OP (Estoque)</a>
                    </div>
                </div>
            </div>

            <input type="file" id="fileInputMaster" accept=".csv" class="hidden" onchange="window.handleImportCSV(event)">
            <input type="file" id="fileInputSOP" accept=".csv" class="hidden" onchange="window.handleImportSOPCSV(event)">
        </div>
    </header>

    <!-- 1. Quadro de POs Abertas -->
    <section id="open-po-summary" class="max-w-7xl mx-auto mb-8 hidden"></section>

    <!-- 2. Remessas Consolidadas -->
    <div id="shipment-wrapper" class="max-w-7xl mx-auto mb-12 hidden">
        <h3 class="text-2xl font-bold text-white mb-6 border-b border-gray-700 pb-2">üì¶ Remessas Consolidadas (Containers)</h3>
        <main id="shipment-container" class="space-y-8"></main>
    </div>

    <!-- 3. Proje√ß√£o de Estoque -->
    <section id="inventory-control" class="max-w-7xl mx-auto mb-8 hidden"></section>

    <!-- 4. Sugest√µes de Reposi√ß√£o -->
    <section id="purchase-suggestions" class="max-w-7xl mx-auto mb-8 hidden"></section>

    <div id="toast" class="fixed bottom-4 right-4 p-4 rounded-lg text-white z-50 transition-all duration-300 shadow-2xl opacity-0 pointer-events-none"></div>

    <script>
        // --- ESTADO GLOBAL ---
        window.MASTER_PO_LIST = []; 
        let MOCK_OPEN_POS = [];
        let MOCK_SHIPMENTS_DATA = [];
        let MOCK_INVENTORY = {};
        let MOCK_SALES_FORECAST = {};
        let MOCK_REPLENISHMENT_PARAMS = {};

        const SIMULATED_TODAY = new Date('2025-12-16T00:00:00');

        const STAGES_LIST = [
            { id: 1, name: "PO - Enviada", icon: "üìß" },
            { id: 2, name: "Em produ√ß√£o", icon: "üè≠" },
            { id: 3, name: "Carga Consolidada (CI)", icon: "üìã" },
            { id: 4, name: "Booking Confirmado", icon: "üìÖ" },
            { id: 5, name: "No Porto (Origem)", icon: "‚öì" },
            { id: 6, name: "Navegando (Em Tr√¢nsito)", icon: "üö¢" },
            { id: 7, name: "Chegou! (Brasil)", icon: "üìç" }, 
            { id: 8, name: "Em Desembara√ßo aduaneiro", icon: "üõ°Ô∏è" },
            { id: 9, name: "Liberado", icon: "üîë" },
            { id: 10, name: "Em Confer√™ncia", icon: "üîç" },
            { id: 11, name: "Dispon√≠vel para Venda", icon: "‚úÖ" }
        ];

        // --- UTILIT√ÅRIOS ---
        function parseDateString(dateStr) {
            if (!dateStr || typeof dateStr !== 'string') return null;
            dateStr = dateStr.trim();
            const dmy = dateStr.match(/^(\d{1,2})[/\-](\d{1,2})[/\-](\d{4})$/);
            if (dmy) return `${dmy[3]}-${dmy[2].padStart(2, '0')}-${dmy[1].padStart(2, '0')}`;
            const ymd = dateStr.match(/^(\d{4})[/\-](\d{1,2})[/\-](\d{1,2})$/);
            if (ymd) return `${ymd[1]}-${ymd[2].padStart(2, '0')}-${ymd[3].padStart(2, '0')}`;
            return null;
        }

        function getDateObject(dateStr) {
            if (!dateStr || dateStr === '-' || dateStr.includes('null')) return null;
            return new Date(dateStr + 'T00:00:00');
        }

        function formatDate(dateStr) {
            if (!dateStr || dateStr === 'null' || dateStr === '-') return '-';
            try {
                const date = getDateObject(dateStr);
                if (!date || isNaN(date.getTime())) return '-';
                return date.toLocaleDateString('pt-BR', { year: 'numeric', month: '2-digit', day: '2-digit' });
            } catch (e) { return '-'; }
        }

        function calculateAvailability(arrivalDateStr) {
            const date = getDateObject(arrivalDateStr);
            if (!date) return null;
            const availDate = new Date(date);
            availDate.setDate(availDate.getDate() + 16);
            const y = availDate.getFullYear();
            const m = String(availDate.getMonth() + 1).padStart(2, '0');
            const d = String(availDate.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function getYearMonthKey(date) {
            if (!date) return null;
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        }

        function getOpenPOStatus(readyDateStr) {
            const readyDate = getDateObject(readyDateStr);
            if (!readyDate) return { status: 'N/A', color: 'text-gray-400 bg-gray-700' };
            const diffDays = Math.round((readyDate.getTime() - SIMULATED_TODAY.getTime()) / 86400000); 
            if (diffDays < 0) return { status: 'Atrasado', color: 'bg-red-900/40 text-red-400' };
            if (diffDays <= 14) return { status: 'No Prazo', color: 'bg-green-900/40 text-green-400' };
            return { status: 'Adiantado', color: 'bg-yellow-900/40 text-yellow-400' };
        }

        function getPOStatus(planned, estimated) {
            const p = getDateObject(planned); const e = getDateObject(estimated);
            if (!p || !e) return { status: 'N/A', color: 'text-gray-400' };
            const diff = Math.round((e.getTime() - p.getTime()) / 86400000);
            if (diff > 5) return { status: 'Atrasado', color: 'bg-red-900/40 text-red-400' };
            if (diff < -5) return { status: 'Adiantado', color: 'bg-yellow-900/40 text-yellow-400' };
            return { status: 'No Prazo', color: 'bg-green-900/40 text-green-400' };
        }

        // --- C√ÅLCULOS S&OP ---
        function calculateStockSimulation() {
            const simulation = {};
            const arrivalData = {};
            
            MOCK_SHIPMENTS_DATA.forEach(ship => {
                ship.purchaseOrders.forEach(po => {
                    const baseArrival = (ship.dates?.portArrivalDate && ship.dates.portArrivalDate !== '-') 
                        ? ship.dates.portArrivalDate 
                        : ship.dates?.estimatedArrival;
                    
                    if (baseArrival && baseArrival !== '-') {
                        const availDateStr = calculateAvailability(baseArrival);
                        const availDate = getDateObject(availDateStr);
                        if (availDate) {
                            const key = getYearMonthKey(availDate);
                            if (key) {
                                arrivalData[key] = arrivalData[key] || {};
                                arrivalData[key][po.item] = (arrivalData[key][po.item] || 0) + po.quantity;
                            }
                        }
                    }
                });
            });

            const allItems = new Set([...Object.keys(MOCK_INVENTORY), ...MOCK_SHIPMENTS_DATA.flatMap(s => s.purchaseOrders.map(p => p.item)), ...Object.keys(MOCK_SALES_FORECAST).flatMap(m => Object.keys(MOCK_SALES_FORECAST[m]))]);
            const months = Object.keys(MOCK_SALES_FORECAST).sort();
            
            if (!months.length) return { simulation: {}, projectionMonths: [] };

            let prevBalance = { ...MOCK_INVENTORY };
            allItems.forEach(item => simulation[item] = { currentStock: MOCK_INVENTORY[item] || 0, periods: {} });

            months.forEach(m => {
                allItems.forEach(item => {
                    const start = prevBalance[item] || 0;
                    const arrival = (arrivalData[m] || {})[item] || 0;
                    const sale = (MOCK_SALES_FORECAST[m] || {})[item] || 0;
                    const end = start + arrival - sale;
                    simulation[item].periods[m] = { startStock: start, arrivals: arrival, sales: sale, endBalance: end };
                    prevBalance[item] = end;
                });
            });
            return { simulation, projectionMonths: months };
        }

        // --- RENDERIZADORES ---
        function generatePOListInShipment(purchaseOrders, containerEstimatedDelivery) {
            return `
                <div class="mt-6 border border-gray-700 rounded-lg overflow-hidden">
                    <div class="bg-gray-700/50 p-2"><h4 class="text-xs font-bold uppercase text-gray-300">Pedidos de Compra (POs) Consolidados</h4></div>
                    <table class="w-full text-xs text-left">
                        <thead class="bg-gray-800 text-gray-400 uppercase text-[9px]">
                            <tr><th class="px-4 py-2">ID PO</th><th class="px-4 py-2">Item</th><th class="px-4 py-2 text-right">Qtd</th><th class="px-4 py-2 text-center">Status</th></tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            ${purchaseOrders.map(po => {
                                const st = getPOStatus(po.plannedAvailability, containerEstimatedDelivery);
                                return `<tr class="hover:bg-gray-700/30">
                                    <td class="px-4 py-2 text-blue-400 font-bold">${po.id}</td>
                                    <td class="px-4 py-2 text-gray-300">${po.item}</td>
                                    <td class="px-4 py-2 text-right text-gray-100 font-mono">${po.quantity.toLocaleString('pt-BR')}</td>
                                    <td class="px-4 py-2 text-center"><span class="px-2 py-0.5 rounded text-[10px] uppercase font-bold ${st.color}">${st.status}</span></td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>`;
        }

        function generateTimeline(currentStageId, shipmentId) {
            return `<div class="flex justify-between items-start text-xs font-semibold mt-4 mb-2 overflow-x-auto p-2">
                ${STAGES_LIST.map(stage => {
                    const isCompleted = stage.id < currentStageId;
                    const isActive = stage.id === currentStageId;
                    const statusClass = isCompleted ? 'bg-green-500' : isActive ? 'bg-blue-500 animate-pulse' : 'bg-gray-600';
                    const textClass = isActive ? 'text-blue-400 font-bold' : 'text-gray-400';
                    return `<div class="flex flex-col items-center flex-shrink-0 min-w-[75px] max-w-[90px]">
                            <div class="w-5 h-5 ${statusClass} rounded-full flex items-center justify-center text-white shadow-md z-10 cursor-pointer" onclick="window.updateShipmentStage('${shipmentId}', ${stage.id})">${isCompleted ? '‚úì' : stage.id}</div>
                            <div class="h-1 w-full -mt-2.5 ${stage.id <= currentStageId - 1 ? 'bg-blue-600' : 'bg-gray-700'}"></div>
                            <span class="mt-1 text-center ${textClass} text-[9px] sm:text-[10px] leading-tight">${stage.name}</span>
                        </div>`;
                }).join('')}
            </div>`;
        }

        function createShipmentCard(shipment) {
            const currentStage = STAGES_LIST.find(s => s.id === shipment.currentStage);
            
            // L√≥gica de fallback para datas Reais: se vazio, usa estimada com sufixo " E" e cor amarela
            const displayDateWithFallback = (real, est) => {
                const formattedReal = formatDate(real);
                if (formattedReal !== '-') return formattedReal;
                
                const formattedEst = formatDate(est);
                if (formattedEst !== '-') return `<span class="text-yellow-400 font-bold">${formattedEst} E</span>`;
                
                return '-';
            };

            const baseArrival = (shipment.dates.portArrivalDate && shipment.dates.portArrivalDate !== '-') ? shipment.dates.portArrivalDate : shipment.dates.estimatedArrival;
            const availDateStr = calculateAvailability(baseArrival);

            return `<div class="bg-gray-800 rounded-xl shadow-xl border border-gray-700 p-6 mb-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 border-b border-gray-700 pb-4">
                    <h2 class="text-2xl font-bold text-gray-100">${shipment.name} (${shipment.commercialInvoiceId})</h2>
                    <div class="flex items-center space-x-2">
                        <span class="px-3 py-1 bg-purple-900/40 text-purple-300 font-semibold text-sm rounded-full">${shipment.supplier}</span>
                        <div class="text-3xl ${shipment.currentStage === 6 ? 'ship-in-transit' : ''}">${currentStage.icon}</div>
                        <span class="px-4 py-1.5 bg-blue-700 font-semibold text-sm rounded-full">${currentStage.name}</span>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <h3 class="text-xs font-bold text-blue-400 uppercase mb-2 tracking-wider">Refer√™ncias</h3>
                        <div class="space-y-1 text-sm text-gray-300">
                            <p><strong>ID Remessa:</strong> ${shipment.shipmentId}</p>
                            <p><strong>No. CI:</strong> ${shipment.commercialInvoiceId}</p>
                            <p><strong>No. Cont√™iner:</strong> <span class="text-yellow-400 font-mono font-bold">${shipment.containerNumber || 'TBA'}</span></p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xs font-bold text-blue-400 uppercase mb-2 tracking-wider">Log√≠stica (Real)</h3>
                        <div class="space-y-1 text-sm text-gray-300">
                            <p><strong>PO Enviada:</strong> ${formatDate(shipment.dates.placed)}</p>
                            <p><strong>Prontid√£o:</strong> ${displayDateWithFallback(shipment.dates.readyToShipDate, shipment.dates.estimatedDeparture)}</p>
                            <p><strong>Embarque:</strong> ${displayDateWithFallback(shipment.dates.shipDepartureDate, shipment.dates.estimatedDeparture)}</p>
                            <p><strong>Chegada:</strong> ${displayDateWithFallback(shipment.dates.portArrivalDate, shipment.dates.estimatedArrival)}</p>
                            <p class="text-green-400 font-bold underline italic mt-2">Disponibilidade (D+16): ${formatDate(availDateStr)}</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xs font-bold text-blue-400 uppercase mb-2 tracking-wider">Estimativas</h3>
                        <div class="space-y-1 text-sm text-gray-300">
                            <p><strong>ETD:</strong> <span class="text-yellow-400 font-bold">${formatDate(shipment.dates.estimatedDeparture)}</span></p>
                            <p><strong>ETA:</strong> <span class="text-yellow-400 font-bold">${formatDate(shipment.dates.estimatedArrival)}</span></p>
                            <p><strong>Entrega Final:</strong> <span class="text-yellow-400 font-bold">${formatDate(shipment.dates.estimatedDelivery)}</span></p>
                        </div>
                    </div>
                </div>
                ${generateTimeline(shipment.currentStage, shipment.shipmentId)}
                ${generatePOListInShipment(shipment.purchaseOrders, shipment.dates.estimatedDelivery)}
            </div>`;
        }

        function renderOrders() {
            // 1. POs Abertas
            const poSec = document.getElementById('open-po-summary');
            if (MOCK_OPEN_POS.length > 0) {
                poSec.classList.remove('hidden');
                const total = MOCK_OPEN_POS.length;
                const sent = MOCK_OPEN_POS.filter(p => p.currentStage === 1).length;
                const prod = MOCK_OPEN_POS.filter(p => p.currentStage === 2).length;
                poSec.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white mb-6 border-b border-gray-700 pb-2">POs Abertas / PIs Emitidas</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-8">
                        <div class="p-4 rounded-lg bg-blue-900/40 border border-blue-700/50"><p class="text-4xl font-extrabold text-blue-400">${total}</p><p class="text-xs text-gray-300 font-bold uppercase tracking-widest">Total de Pedidos</p></div>
                        <div class="p-4 rounded-lg bg-green-900/40 border border-green-700/50"><p class="text-4xl font-extrabold text-green-400">${sent}</p><p class="text-xs text-gray-300 font-bold uppercase tracking-widest">PO - Enviada</p></div>
                        <div class="p-4 rounded-lg bg-yellow-900/40 border border-yellow-700/50"><p class="text-4xl font-extrabold text-yellow-400">${prod}</p><p class="text-xs text-gray-300 font-bold uppercase tracking-widest">Em Produ√ß√£o</p></div>
                    </div>
                    <div class="overflow-x-auto rounded-lg border border-gray-700">
                        <table class="w-full text-sm text-left border-collapse"><thead class="bg-gray-700 text-gray-200"><tr><th class="px-4 py-3 uppercase text-xs">ID PO</th><th class="px-4 py-3 uppercase text-xs">Fornecedor</th><th class="px-4 py-3 uppercase text-xs">Item</th><th class="px-4 py-3 text-center uppercase text-xs">Status</th></tr></thead>
                        <tbody class="divide-y divide-gray-700">${MOCK_OPEN_POS.map(p => {
                            const st = getOpenPOStatus(p.readyDate);
                            return `<tr class="hover:bg-gray-700/50"><td class="px-4 py-3 text-blue-400 font-bold">${p.id}</td><td class="px-4 py-3">${p.supplier}</td><td class="px-4 py-3 text-gray-300">${p.item} (${p.quantity.toLocaleString('pt-BR')})</td><td class="px-4 py-3 text-center"><span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase ${st.color}">${st.status}</span></td></tr>`
                        }).join('')}</tbody></table>
                    </div>
                </div>`;
            } else { 
                poSec.innerHTML = '';
                poSec.classList.add('hidden');
            }

            // 2. Remessas
            const shipWrapper = document.getElementById('shipment-wrapper');
            const shipContainer = document.getElementById('shipment-container');
            if (MOCK_SHIPMENTS_DATA.length > 0) {
                shipWrapper.classList.remove('hidden');
                shipContainer.innerHTML = MOCK_SHIPMENTS_DATA.map(createShipmentCard).join('');
            } else { 
                shipWrapper.classList.add('hidden'); 
            }

            renderSOP();
        }

        function renderSOP() {
            const { simulation, projectionMonths: months } = calculateStockSimulation();
            const invSec = document.getElementById('inventory-control');
            const sugSec = document.getElementById('purchase-suggestions');
            
            if (!months.length) {
                invSec.innerHTML = '';
                invSec.classList.add('hidden');
                sugSec.innerHTML = '';
                sugSec.classList.add('hidden');
                return;
            }

            invSec.classList.remove('hidden');
            const headerMonths = months.map(m => `<th colspan="3" class="px-3 py-3 text-center text-xs border-l border-gray-700 bg-gray-700/50 uppercase">${m}</th>`).join('');
            const subHeaders = months.map(() => `<th class="px-3 py-2 text-right text-[10px] border-l border-gray-700 uppercase">Cheg</th><th class="px-3 py-2 text-right text-[10px] uppercase">Vend</th><th class="px-3 py-2 text-right text-[10px] font-bold uppercase">Saldo</th>`).join('');

            invSec.innerHTML = `<div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-xl mt-8">
                <h3 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-2">Proje√ß√£o de Estoque Futuro (S&OP)</h3>
                <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-700 text-gray-200">
                        <tr><th rowspan="2" class="px-6 py-3 text-left text-xs uppercase sticky left-0 bg-gray-700">Item</th><th rowspan="2" class="px-6 py-3 text-right text-xs uppercase border-l border-gray-600">Estoque</th>${headerMonths}</tr>
                        <tr class="bg-gray-700/70">${subHeaders}</tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700 text-xs">
                        ${Object.entries(simulation).map(([item, d]) => `<tr><td class="px-6 py-3 font-semibold sticky left-0 bg-gray-800">${item}</td><td class="px-6 py-3 text-sm text-right font-bold text-blue-400">${d.currentStock.toLocaleString('pt-BR')}</td>
                        ${months.map(m => {
                            const p = d.periods[m];
                            const ss = MOCK_REPLENISHMENT_PARAMS[item]?.SS_units || 0;
                            const balClass = p.endBalance < 0 ? 'text-red-400 font-bold' : (p.endBalance < ss ? 'text-yellow-400' : 'text-green-400');
                            return `<td class="px-3 py-2 text-right text-gray-400 border-l border-gray-700 opacity-60">${p.arrivals.toLocaleString('pt-BR')}</td><td class="px-3 py-2 text-right text-gray-400 opacity-60">${p.sales.toLocaleString('pt-BR')}</td><td class="px-3 py-2 text-right font-bold ${balClass}">${p.endBalance.toLocaleString('pt-BR')}</td>`;
                        }).join('')}</tr>`).join('')}
                    </tbody>
                </table></div></div>`;

            // Tabela Sugest√µes
            const suggestions = [];
            Object.entries(simulation).forEach(([item, d]) => {
                const params = MOCK_REPLENISHMENT_PARAMS[item];
                if (!params) return;
                for (const m of months) {
                    if (d.periods[m].endBalance < params.SS_units) {
                        const dl = getDateObject(m + '-01'); if (!dl) return;
                        dl.setDate(dl.getDate() - params.LT_days);
                        suggestions.push({ item, ss: params.SS_units, lt: params.LT_days, quantity: Math.max(1, params.SS_units - d.periods[m].endBalance + (MOCK_SALES_FORECAST[m]?.[item] || 0)), month: m, deadline: dl, urgent: dl < SIMULATED_TODAY });
                        break;
                    }
                }
            });

            if (suggestions.length > 0) {
                sugSec.classList.remove('hidden');
                sugSec.innerHTML = `<div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-xl mt-8">
                    <h3 class="text-2xl font-bold text-red-500 mb-4 border-b border-red-900/40 pb-2 flex items-center">üö® Sugest√µes de Reposi√ß√£o Urgente</h3>
                    <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-700 text-sm">
                        <thead class="bg-red-900/20 text-gray-200 uppercase text-[10px]"><tr><th class="px-4 py-3 text-left">Item</th><th class="px-4 py-3 text-right">Estoque Seg. (SS)</th><th class="px-4 py-3 text-right">Lead Time (LT)</th><th class="px-4 py-3 text-right">Qtd Sugerida</th><th class="px-4 py-3 text-center">M√™s D√©ficit</th><th class="px-4 py-3 text-center">Status / Data Limite</th></tr></thead>
                        <tbody class="divide-y divide-gray-700 text-xs">${suggestions.map(s => `<tr><td class="px-4 py-3 font-semibold text-sm">${s.item}</td><td class="px-4 py-3 text-right">${s.ss.toLocaleString('pt-BR')}</td><td class="px-4 py-3 text-right">${s.lt} d</td><td class="px-4 py-3 text-right text-blue-400 font-bold">${Math.ceil(s.quantity).toLocaleString('pt-BR')}</td><td class="px-4 py-3 text-center">${s.month}</td><td class="px-4 py-3 text-center ${s.urgent ? 'text-red-400 font-bold' : 'text-yellow-400'}">${s.urgent ? 'URGENTE' : 'A√ß√£o Necess√°ria'}<br/><small class="opacity-70">${s.deadline.toLocaleDateString('pt-BR')}</small></td></tr>`).join('')}</tbody>
                    </table></div></div>`;
            } else {
                sugSec.innerHTML = '';
                sugSec.classList.add('hidden');
            }
        }

        function rebuildLocalData(dataList) {
            MOCK_OPEN_POS = [];
            let shipmentMap = {};
            dataList.forEach(row => {
                const sId = row.shipmentId;
                if (sId && sId !== "") {
                    shipmentMap[sId] = shipmentMap[sId] || {
                        shipmentId: sId, commercialInvoiceId: row.commercialInvoiceId || sId,
                        containerNumber: row.containerNumber, supplier: row.supplier || 'N/A',
                        name: `Remessa ${sId}`, currentStage: parseInt(row.shipmentCurrentStage) || 3,
                        dates: { 
                            estimatedDeparture: parseDateString(row.estimatedDeparture), 
                            estimatedArrival: parseDateString(row.estimatedArrival), 
                            estimatedDelivery: parseDateString(row.estimatedDelivery), 
                            placed: parseDateString(row.poSentDate),
                            readyToShipDate: parseDateString(row.poReadyDate),
                            shipDepartureDate: parseDateString(row.shipDepartureDate), 
                            portArrivalDate: parseDateString(row.portArrivalDate) 
                        }, purchaseOrders: []
                    };
                    shipmentMap[sId].purchaseOrders.push({ id: row.poId, item: row.item, quantity: parseInt(row.quantity) || 0, plannedAvailability: parseDateString(row.estimatedDelivery) });
                } else {
                    MOCK_OPEN_POS.push({ id: row.poId, supplier: row.supplier, item: row.item, quantity: parseInt(row.quantity) || 0, readyDate: parseDateString(row.poReadyDate), units: row.units || 'un', currentStage: parseInt(row.poCurrentStage) || 1 });
                }
            });
            MOCK_SHIPMENTS_DATA = Object.values(shipmentMap).filter(s => s.purchaseOrders.length > 0);
            renderOrders();
        }

        // --- INTERA√á√ïES CSV ---
        window.handleImportCSV = (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const lines = ev.target.result.split('\n').filter(l => l.trim());
                if (lines.length < 2) return;
                const headers = lines[0].split(';').map(h => h.trim().replace(/"/g, ''));
                
                lines.slice(1).forEach(line => {
                    const vals = line.split(';');
                    const obj = {}; headers.forEach((h, i) => obj[h] = vals[i] || "");
                    
                    if (!obj.poId || obj.poId.toLowerCase().includes("id po") || obj.poId.toLowerCase().includes("obrigat√≥rio")) return;

                    const existingIdx = MASTER_PO_LIST.findIndex(p => p.poId === obj.poId);
                    if (existingIdx > -1) {
                        Object.keys(obj).forEach(key => { if (obj[key] !== "") MASTER_PO_LIST[existingIdx][key] = obj[key]; });
                    } else { MASTER_PO_LIST.push(obj); }
                });

                rebuildLocalData(MASTER_PO_LIST);
                document.getElementById('last-update-time').innerText = new Date().toLocaleString('pt-BR');
                showToast("Dados atualizados!", "bg-blue-600");
            };
            reader.readAsText(file);
        };

        window.handleImportSOPCSV = (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const lines = ev.target.result.split('\n').filter(l => l.trim());
                if (lines.length < 2) return;
                const headers = lines[0].split(';').map(h => h.trim().replace(/"/g, ''));
                
                lines.slice(1).forEach(line => {
                    const vals = line.split(';'); const obj = {}; headers.forEach((h, i) => obj[h] = vals[i] || "");
                    
                    if (!obj.item || obj.item.toLowerCase().includes("nome item") || obj.item.toLowerCase().includes("item-name")) return;

                    MOCK_INVENTORY[obj.item] = Number(obj.currentStock) || 0;
                    MOCK_REPLENISHMENT_PARAMS[obj.item] = { SS_units: Number(obj.ssUnits) || 0, LT_days: Number(obj.ltDays) || 0 };
                    Object.keys(obj).forEach(k => { if (k.startsWith('sales_')) { const m = k.substring(6); MOCK_SALES_FORECAST[m] = MOCK_SALES_FORECAST[m] || {}; MOCK_SALES_FORECAST[m][obj.item] = Number(obj[k]) || 0; } });
                });
                renderOrders();
                showToast("Estoque atualizado!", "bg-purple-600");
            };
            reader.readAsText(file);
        };

        window.updateShipmentStage = (id, stage) => {
            const ship = MOCK_SHIPMENTS_DATA.find(s => s.shipmentId === id);
            if (ship) {
                ship.currentStage = stage;
                const today = new Date().toISOString().slice(0, 10);
                if (stage === 6) ship.dates.shipDepartureDate = today;
                if (stage === 7) ship.dates.portArrivalDate = today;
                renderOrders();
                showToast("Status alterado!", "bg-green-600");
            }
        };

        window.handleImportClick = (type) => document.getElementById(type === 'master' ? 'fileInputMaster' : 'fileInputSOP').click();
        window.toggleDropdown = () => document.getElementById('dropdownMenu').classList.toggle('hidden');
        window.handleDownloadTemplateCSV = () => {
            const h = "action;poId;piNo;supplier;item;quantity;units;poReadyDate;poCurrentStage;shipmentId;commercialInvoiceId;type;shipmentCurrentStage;estimatedDeparture;estimatedArrival;estimatedDelivery;containerNumber;poSentDate;shipDepartureDate;portArrivalDate";
            const b = new Blob([h], { type: 'text/csv' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = "modelo_logistica.csv"; a.click();
        };
        window.handleDownloadSOPTemplate = () => {
            const h = "item;currentStock;ssUnits;ltDays;sales_2026-01;sales_2026-02";
            const b = new Blob([h], { type: 'text/csv' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = "modelo_sop.csv"; a.click();
        };
        window.handleExportCSV = () => alert("Exporta√ß√£o simulada.");

        function showToast(msg, color) {
            const t = document.getElementById('toast');
            t.className = `fixed bottom-4 right-4 p-4 rounded-lg text-white z-50 transition-all duration-300 shadow-2xl opacity-100 ${color}`;
            t.innerText = msg;
            setTimeout(() => { if (t) t.classList.replace('opacity-100', 'opacity-0'); }, 3000);
        }

        window.onload = renderOrders;
    </script>
</body>
</html>
